# WebDAV 功能使用指南

## 概述

MediaLibrary 插件已集成完整的 WebDAV 功能，支持文件上传、管理和同步操作。

## 功能特性

### ✅ 已实现的功能

1. **WebDAV 客户端**
   - 连接 WebDAV 服务器
   - 列出目录内容
   - 上传文件到 WebDAV
   - 下载文件从 WebDAV
   - 创建目录
   - 删除文件/目录
   - SSL 证书验证选项

2. **用户界面**
   - 侧边栏 WebDAV 管理器
   - 文件列表展示
   - 目录导航
   - 操作按钮（刷新、上一级、新建文件夹、上传）
   - 实时状态反馈

3. **文件同步**
   - 从 WebDAV 下载文件到本地缓存 (`usr/uploads/webdav`)
   - 将 WebDAV 文件同步到 Typecho 媒体库
   - 自动添加到媒体库数据库
   - 保留文件元数据

4. **存储管理**
   - 本地存储标识
   - WebDAV 存储标识
   - 存储类型筛选

## 配置步骤

### 1. 启用 WebDAV

在插件配置页面中：

1. 勾选 **启用 WebDAV 文件管理**
2. 填写 **WebDAV 服务地址**（例如：`https://example.com/remote.php/dav/files/username`）
3. 填写 **默认子路径**（可选，例如：`/typecho`）
4. 填写 **WebDAV 用户名**
5. 填写 **WebDAV 密码**
6. 选择是否 **验证 SSL 证书**（自签名证书可取消勾选）

### 2. 测试连接

保存配置后，插件会自动测试连接：
- ✅ 绿色 = 连接成功
- ⚠️ 黄色 = 配置不完整
- ❌ 红色 = 连接失败

### 3. 使用 WebDAV 管理器

在媒体库管理页面的左侧边栏，你会看到 **WebDAV 文件管理** 面板：

#### 操作按钮

- **刷新**：重新加载当前目录
- **上一级**：返回上级目录
- **新建文件夹**：在当前目录创建新文件夹
- **上传文件**：上传文件到当前目录

#### 文件操作

对于每个文件，可以进行以下操作：

- **同步**：将 WebDAV 文件同步到本地 Typecho 媒体库
- **复制链接**：复制文件的公开访问链接
- **删除**：删除文件或文件夹

## 目录结构

```
/usr/uploads/webdav/          # WebDAV 本地缓存目录
├── .htaccess                 # Apache 访问控制
├── README.md                 # 目录说明
└── [同步的文件]              # 从 WebDAV 同步的文件
```

## 文件同步流程

### 同步到本地媒体库

1. 在 WebDAV 文件列表中点击文件的 **同步** 按钮
2. 确认同步操作
3. 系统会：
   - 从 WebDAV 服务器下载文件
   - 保存到 `/usr/uploads/webdav/` 缓存目录
   - 复制文件到 Typecho 上传目录 (`/usr/uploads/`)
   - 在数据库中创建附件记录
   - 标记为 `webdav` 存储类型

4. 同步完成后页面会自动刷新，新文件将出现在媒体库中

## 存储类型筛选

在侧边栏的 **存储类型** 部分，可以筛选不同来源的文件：

- **本地存储**：传统上传方式的文件
- **WebDAV**：从 WebDAV 同步的文件
- **对象存储**：未来版本将支持

## 安全注意事项

1. **密码安全**：WebDAV 密码存储在数据库中，请确保数据库安全
2. **SSL 证书**：生产环境建议使用有效的 SSL 证书
3. **目录权限**：确保 `usr/uploads/webdav/` 目录有正确的读写权限（755）
4. **文件访问**：WebDAV 缓存目录受 `.htaccess` 保护

## 常见问题

### Q: WebDAV 连接失败怎么办？

A: 检查以下几点：
- WebDAV 服务器地址是否正确
- 用户名和密码是否正确
- 服务器是否需要 SSL 证书验证
- 服务器防火墙是否允许连接
- cURL 扩展是否已安装

### Q: 同步的文件存储在哪里？

A:
- 缓存：`/usr/uploads/webdav/[文件路径]`
- 媒体库：`/usr/uploads/[文件名]_[时间戳].[扩展名]`

### Q: 如何批量同步文件？

A: 当前版本需要单独同步每个文件，批量同步功能将在后续版本中添加。

### Q: 删除 WebDAV 文件会影响媒体库吗？

A: 不会。删除 WebDAV 文件只删除远程文件，已同步到媒体库的文件不受影响。

## 技术实现

### 后端

- **WebDAVClient.php**：WebDAV 客户端类，处理所有 WebDAV 操作
- **AjaxHandler.php**：Ajax 请求处理，包含同步逻辑
- **PanelHelper.php**：状态管理和配置处理

### 前端

- **panel.js**：WebDAVManager 对象，处理用户交互
- **panel.css**：WebDAV 界面样式
- **webdav-manager.php**：WebDAV 管理器模板

### 数据库

同步的文件在 `contents` 表中添加以下标记：
```php
'text' => serialize([
    'storage' => 'webdav',  // 存储类型标识
    // ... 其他文件信息
])
```

## 开发计划

未来版本计划添加：

- [ ] 批量同步功能
- [ ] 双向同步（本地到 WebDAV）
- [ ] 自动同步调度
- [ ] 冲突解决机制
- [ ] 同步历史记录
- [ ] 增量同步
- [ ] 文件预览

## 许可证

本功能作为 MediaLibrary 插件的一部分，遵循相同的许可证。

## 更新日志

### v0.1.1 (2025-01-24)
- ✅ 实现 WebDAV 客户端基础功能
- ✅ 添加 WebDAV 管理界面
- ✅ 实现文件上传、删除、创建目录
- ✅ 实现文件同步到本地媒体库
- ✅ 添加存储类型筛选
- ✅ 自动创建 webdav 缓存目录

---

**注意**：本功能基于标准 WebDAV 协议实现，兼容 Nextcloud、ownCloud、坚果云等主流 WebDAV 服务。
