# WebDAV 功能使用指南

## 概述

MediaLibrary 插件已集成完整的 WebDAV 功能，支持**双向同步**：从 WebDAV 下载文件到本地，以及将本地文件同步到 WebDAV 服务器。

## 功能特性

### ✅ 已实现的功能

1. **WebDAV 客户端**
   - 连接 WebDAV 服务器
   - 列出目录内容
   - 上传文件到 WebDAV
   - 下载文件从 WebDAV
   - 创建目录
   - 删除文件/目录
   - SSL 证书验证选项

2. **用户界面**
   - 侧边栏 WebDAV 管理器
   - 文件列表展示
   - 目录导航
   - 操作按钮（刷新、上一级、新建文件夹、上传）
   - 实时状态反馈

3. **双向文件同步** ⭐ 新增
   - **WebDAV → 本地**：从 WebDAV 下载文件到本地缓存和媒体库
   - **本地 → WebDAV**：将本地媒体库文件批量同步到 WebDAV 服务器
   - 自动跳过已同步文件
   - 同步进度显示
   - 详细的同步结果统计

4. **同步配置** ⭐ 新增
   - 启用/禁用自动同步
   - 设置同步目标路径
   - 三种同步模式：手动、上传时自动、定时同步
   - 可选的双向删除同步

5. **存储管理**
   - 本地存储标识
   - WebDAV 存储标识
   - 存储类型筛选
   - 同步状态标记

## 配置步骤

### 1. 启用 WebDAV

在插件配置页面中：

1. 勾选 **启用 WebDAV 文件管理**
2. 填写 **WebDAV 服务地址**（例如：`https://example.com/remote.php/dav/files/username`）
3. 填写 **默认子路径**（可选，例如：`/typecho`）
4. 填写 **WebDAV 用户名**
5. 填写 **WebDAV 密码**
6. 选择是否 **验证 SSL 证书**（自签名证书可取消勾选）

### 2. 配置同步选项 ⭐ 新增

**同步配置**部分：

1. **启用自动同步**：勾选以启用本地到 WebDAV 的同步功能
2. **同步目标路径**：设置 WebDAV 服务器上的目标目录（如 `/uploads` 或 `/typecho/media`）
3. **同步模式**：
   - **手动同步**：通过管理面板的"批量同步"按钮触发
   - **上传时自动同步**：每次上传文件时自动同步到 WebDAV（开发中）
   - **定时同步**：需配置系统定时任务（开发中）
4. **双向同步删除**：勾选后，删除本地文件时也会删除 WebDAV 上的对应文件（谨慎使用）

### 3. 测试连接

保存配置后，插件会自动测试连接：
- ✅ 绿色 = 连接成功
- ⚠️ 黄色 = 配置不完整
- ❌ 红色 = 连接失败

## 使用方法

### WebDAV 文件管理

在媒体库管理页面的左侧边栏，你会看到 **WebDAV 文件管理** 面板：

#### 操作按钮

- 🔄 **刷新**：重新加载当前目录
- ⬆️ **上一级**：返回上级目录
- 📁 **新建文件夹**：在当前目录创建新文件夹
- 📤 **上传文件**：上传文件到当前目录

#### 文件操作

对于每个 WebDAV 文件，可以进行以下操作：

- 🔄 **同步**：将文件同步到 Typecho 媒体库
- 🔗 **复制链接**：复制文件的公开访问链接
- 🗑️ **删除**：删除文件或文件夹

### 本地到 WebDAV 同步 ⭐ 新增

#### 批量同步所有文件

1. 确保已启用"自动同步"配置
2. 在 WebDAV 管理面板中，点击 **📤 批量同步所有文件** 按钮
3. 确认同步操作
4. 等待同步完成，查看进度条和结果统计

**同步结果**会显示：
- ✅ 成功同步的文件数
- ❌ 失败的文件数（含错误详情）
- ⏭️ 跳过的文件数（已同步的文件会自动跳过）
- 📊 总文件数

#### 同步状态标记

文件同步后，数据库中会添加以下标记：
- `webdav_synced`: true（已同步标记）
- `webdav_path`: 远程路径
- `webdav_sync_time`: 同步时间戳

已同步的文件在下次批量同步时会自动跳过，避免重复上传。

## 目录结构

```
/usr/uploads/webdav/          # WebDAV 本地缓存目录
├── .htaccess                 # Apache 访问控制
├── README.md                 # 目录说明
└── [同步的文件]              # 从 WebDAV 下载的文件
```

## 同步流程说明

### 从 WebDAV 同步到本地

1. 在 WebDAV 文件列表中点击文件的 **同步** 按钮
2. 确认同步操作
3. 系统会：
   - 从 WebDAV 服务器下载文件
   - 保存到 `/usr/uploads/webdav/` 缓存目录
   - 复制文件到 Typecho 上传目录 (`/usr/uploads/`)
   - 在数据库中创建附件记录
   - 标记为 `webdav` 存储类型

4. 同步完成后页面会自动刷新，新文件将出现在媒体库中

### 从本地同步到 WebDAV ⭐ 新增

1. 点击 **批量同步所有文件** 按钮
2. 确认同步操作
3. 系统会：
   - 扫描所有本地媒体库文件
   - 跳过已同步的文件
   - 上传未同步的文件到 WebDAV 目标路径
   - 在数据库中标记已同步状态
   - 显示同步进度和结果

4. 同步完成后会显示详细统计信息

## 安全注意事项

1. **密码安全**：WebDAV 密码存储在数据库中，请确保数据库安全
2. **SSL 证书**：生产环境建议使用有效的 SSL 证书
3. **目录权限**：确保 `usr/uploads/webdav/` 目录有正确的读写权限（755）
4. **文件访问**：WebDAV 缓存目录受 `.htaccess` 保护
5. **同步删除**：谨慎启用"双向同步删除"，避免误删重要文件
6. **网络超时**：大量文件同步时请确保网络稳定，避免超时

## 常见问题

### Q: WebDAV 连接失败怎么办？

A: 检查以下几点：
- WebDAV 服务器地址是否正确
- 用户名和密码是否正确
- 服务器是否需要 SSL 证书验证
- 服务器防火墙是否允许连接
- cURL 扩展是否已安装

### Q: 同步的文件存储在哪里？

A:
- **从 WebDAV 下载**：
  - 缓存：`/usr/uploads/webdav/[文件路径]`
  - 媒体库：`/usr/uploads/[文件名]_[时间戳].[扩展名]`
- **上传到 WebDAV**：
  - 远程：`[同步目标路径]/[文件名]`（如 `/uploads/image.jpg`）

### Q: 如何避免重复同步？

A: 系统会自动跟踪已同步的文件：
- 本地文件同步到 WebDAV 后，会在数据库中标记 `webdav_synced = true`
- 批量同步时自动跳过已同步的文件
- 可通过同步结果的"跳过"数量查看

### Q: 同步失败的原因有哪些？

A: 常见失败原因：
- 本地文件不存在或已删除
- WebDAV 服务器空间不足
- 网络连接超时
- 目标目录权限不足
- 文件名包含非法字符

### Q: 删除 WebDAV 文件会影响媒体库吗？

A: 不会。删除 WebDAV 文件只删除远程文件，已同步到媒体库的文件不受影响。

### Q: 批量同步需要多长时间？

A: 取决于：
- 文件数量和大小
- 网络速度
- WebDAV 服务器性能
- 建议分批同步大量文件，避免超时

## 性能优化建议

1. **分批同步**：如果文件很多，建议分多次同步，避免超时
2. **网络优化**：使用稳定的网络连接，避免移动网络
3. **服务器配置**：适当提高 PHP 超时时间（`max_execution_time`）
4. **定时同步**：对于大量文件，建议使用定时任务在低峰期同步

## 技术实现

### 后端

- **WebDAVClient.php**：WebDAV 客户端类
  - `uploadFile()` - 上传文件
  - `downloadFile()` - 下载文件
  - `listDirectory()` - 列出目录
  - `createDirectory()` - 创建目录
  - `delete()` - 删除文件/目录

- **AjaxHandler.php**：Ajax 请求处理
  - `webdav_sync_to_local` - WebDAV 到本地
  - `webdav_sync_from_local` - 单个文件同步到 WebDAV
  - `webdav_sync_all_local` - 批量同步到 WebDAV

- **PanelHelper.php**：配置和状态管理

### 前端

- **panel.js**：WebDAVManager 对象
  - `syncToLocal()` - 同步到本地
  - `syncAllToWebDAV()` - 批量同步到 WebDAV
- **panel.css**：同步界面样式
- **webdav-manager.php**：同步控制面板模板

### 数据库

同步的文件在 `contents` 表中添加以下标记：
```php
'text' => serialize([
    'storage' => 'webdav',      // 存储类型
    'webdav_synced' => true,    // 已同步标记
    'webdav_path' => '/path',   // 远程路径
    'webdav_sync_time' => 1234, // 同步时间
    // ... 其他文件信息
])
```

## 开发计划

未来版本计划添加：

- [x] 本地到 WebDAV 批量同步
- [ ] 上传时自动同步到 WebDAV
- [ ] 定时同步任务
- [ ] 增量同步（只同步新文件）
- [ ] 双向同步冲突解决
- [ ] 同步历史记录和日志
- [ ] 同步任务队列管理
- [ ] 文件完整性校验

## 许可证

本功能作为 MediaLibrary 插件的一部分，遵循相同的许可证。

## 更新日志

### v0.2.0 (2025-01-24)
- ✅ 添加本地到 WebDAV 批量同步功能
- ✅ 添加同步配置选项（模式、目标路径等）
- ✅ 添加同步进度显示和结果统计
- ✅ 添加已同步文件的自动跳过
- ✅ 更新文档说明双向同步功能

### v0.1.1 (2025-01-24)
- ✅ 实现 WebDAV 客户端基础功能
- ✅ 添加 WebDAV 管理界面
- ✅ 实现文件上传、删除、创建目录
- ✅ 实现文件同步到本地媒体库
- ✅ 添加存储类型筛选
- ✅ 自动创建 webdav 缓存目录

---

**注意**：本功能基于标准 WebDAV 协议实现，兼容 Nextcloud、ownCloud、坚果云等主流 WebDAV 服务。
